---
title: CDPR-Copper for Comps
output:
  html_document:
    keep_md: true
---

## Setup
```{r Setup}

library(ggplot2)
library(plotly)
library(tidyverse)
library(scales) # for viz
library(RColorBrewer) # for viz

# For spatial work
library(sf)
library(mapview) # plotting
library(leafpop) # for customizing popups on maps
```

## Read in Data: CDPR
```{r Read in Data: CDPR}

cdpr <- read_csv("D:/LocalRepos/CDPR-Copper_ExternalData/CalPIP_Cu_2008-2021.csv")

```

## CDPR Data Clean-up
### Clean up SITES and Columns
```{r CDPR: Keep Any Ag SITES and Keep ONLY rice SITES}

# Counts of site types
sites <- cdpr %>% count(SITE_NAME)

# create df with ag-related SITE only, including any outdoor-related plant production
allCu <- cdpr %>% 
  filter(SITE_NAME != "" & 
           SITE_NAME != "AIRPORTS AND LANDING FIELDS (RUNWAYS, ETC.)" & 
           SITE_NAME != "ANTIFOULING TREATMENT SITES (ALL OR UNSPEC)" & 
           SITE_NAME != "AQUATIC AREAS, WATER AREAS (ALL OR UNSPEC)" & 
           SITE_NAME != "AQUATIC SITE - INDUSTRIAL USE (COMBINED SITE)" & 
           SITE_NAME != "BUILDINGS AND STRUCTURES (NON-AG OUTDOOR)" & 
           SITE_NAME != "COMMODITY FUMIGATION" & 
           SITE_NAME != "COUNTY AG. COMM. SALES" & 
           SITE_NAME != "FUMIGATION, OTHER" & 
           SITE_NAME != "HUMAN DRINKING WATER SYSTEMS (POTABLE)" & 
           SITE_NAME != "INDUSTRIAL PROCESSING WATER" & 
           SITE_NAME != "INDUSTRIAL WASTE DISPOSAL SYSTEMS, DISPOSAL WATER" & 
           SITE_NAME != "IRRIGATION SYSTEMS (DITCHES, CANAL BANKS, ETC.)" & 
           SITE_NAME != "LANDSCAPE MAINTENANCE" & 
           SITE_NAME != "N-GRNHS GRWN CUT FLWRS OR GREENS" & 
           SITE_NAME != "N-GRNHS GRWN PLANTS IN CONTAINERS" & 
           SITE_NAME != "N-GRNHS GRWN TRNSPLNT/PRPGTV MTRL" & 
           # SITE_NAME != "N-OUTDR CONTAINER/FLD GRWN PLANTS" & 
           # SITE_NAME != "N-OUTDR GRWN CUT FLWRS OR GREENS" & 
           # SITE_NAME != "N-OUTDR GRWN TRNSPLNT/PRPGTV MTRL " & 
           SITE_NAME != "ORNAMENTAL TURF (ALL OR UNSPEC)" & 
           SITE_NAME != "PUBLIC HEALTH PEST CONTROL" & 
           SITE_NAME != "RECREATIONAL AREAS, TENNIS COURTS, PARKS, ETC." & 
           SITE_NAME != "REGULATORY PEST CONTROL" & 
           SITE_NAME != "RESEARCH COMMODITY" & 
           SITE_NAME != "RIGHTS OF WAY" & 
           # SITE_NAME != "SOIL APPLICATION, PREPLANT-OUTDOOR (SEEDBEDS,ETC.)" & 
           SITE_NAME != "STRUCTURAL PEST CONTROL" & 
           SITE_NAME != "TURF, GOLF COURSE (FAIRWAYS, GREENS, ROUGH)" & 
           # SITE_NAME != "UNCULTIVATED AGRICULTURAL AREAS (ALL OR UNSPEC)" & 
           SITE_NAME != "UNCULTIVATED NON-AG AREAS (ALL OR UNSPEC)" & 
           SITE_NAME != "VERTEBRATE PEST CONTROL" & 
           SITE_NAME != "WOOD PROTECTION TREATMENTS (ALL OR UNSPECIFIED)")


# Create df with rice-related SITE values only (total 14731 rows)
rice <- cdpr %>%
  filter(SITE_NAME == "RICE (ALL OR UNSPEC)" | SITE_NAME == "RICE, WILD (GRAIN CROP)")


# Remove unnecessary columns
allCu <- allCu[,-c(1, 3)]
rice <- rice[,-c(1, 3)]

# Remove NA, blank values
sum(is.na(allCu$POUNDS_CHEMICAL_APPLIED))
sum(is.na(allCu$APPLICATION_MONTH))
sum(allCu$POUNDS_CHEMICAL_APPLIED == "")
sum(allCu$APPLICATION_MONTH == "")

sum(is.na(rice$POUNDS_CHEMICAL_APPLIED))
sum(is.na(rice$APPLICATION_MONTH))
sum(rice$POUNDS_CHEMICAL_APPLIED == "")
sum(rice$APPLICATION_MONTH == "")

allCu <- allCu %>%
  filter(!is.na(POUNDS_CHEMICAL_APPLIED)) %>%
  filter(!is.na(APPLICATION_MONTH))

rice <- rice %>%
  filter(!is.na(POUNDS_CHEMICAL_APPLIED)) %>%
  filter(!is.na(APPLICATION_MONTH))
```

### Read in 1990-2007 Data and bind to rice df
```{r Read in 1990-2007 data and bind}

earlyrice <- read_csv("D:/LocalRepos/CDPR-Copper_ExternalData/CalPIP_Cu_Rice_1990-2007.csv")

# For now, I'm just making this a separate df from the below stuff so that the mapping code doesn't get messed up.  Eventually need to incorporate all years into the mapping df though for rice.

names(rice)
names(earlyrice)

earlyrice <- earlyrice[ , -c(1, 3)]

rice_all <- bind_rows(rice, earlyrice)
```

#### rice_all: Clean up column info and plots
```{r rice_all: Clean up}

# Quick column clean-up
rice_all$APPLICATION_MONTH <- factor(str_to_title(rice_all$APPLICATION_MONTH),
                                  levels = c("January", "February", "March", "April", "May", "June", 
                                             "July", "August", "September", "October", "November", "December"))
rice_all$COUNTY_NAME <- factor(str_to_title(rice_all$COUNTY_NAME))
rice_all$CHEMICAL_NAME <- factor(str_to_title(rice_all$CHEMICAL_NAME))
rice_all$SITE_NAME <- factor(str_to_title(rice_all$SITE_NAME))
rice_all$PRODUCT_NAME <- factor(str_to_title(rice_all$PRODUCT_NAME))

# Convert pounds to kilograms
rice_all <- rice_all %>%
  mutate(KG_CHEMICAL_APPLIED = POUNDS_CHEMICAL_APPLIED*0.4535924,
         .after = POUNDS_CHEMICAL_APPLIED)

# Convert pounds chemical to pounds copper
rice_all <- rice_all %>%
  mutate(Cu_Conversion = case_when(CHEMICAL_NAME == "Copper Sulfate (Pentahydrate)" ~ 0.2545,
                                   CHEMICAL_NAME == "Copper" ~ 1,
                                   CHEMICAL_NAME == "Copper Sulfate (Basic)" ~ 0.4929,
                                   CHEMICAL_NAME == "Copper Hydroxide" ~ 0.6513,
                                   CHEMICAL_NAME == "Copper Oxychloride" ~ 0.2975,
                                   CHEMICAL_NAME == "Copper Sulfate (Anhydrous)" ~ 0.3981,
                                   CHEMICAL_NAME == "Copper Diammonium Diacetate Complex" ~ 0.08),
         .after = KG_CHEMICAL_APPLIED)

rice_all <- rice_all %>%
  mutate(KG_COPPER_APPLIED = KG_CHEMICAL_APPLIED*Cu_Conversion,
         .after = Cu_Conversion)
```

```{r rice_all: Plots}
# Plotting for Comps Proposal

# Plot of KG_CHEMICAL_APPLIED
rice_all %>%
  group_by(YEAR) %>%
  summarize(KG_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = factor(YEAR), y = KG_CHEMICAL_APPLIED)) + 
  stat_summary(fun = "sum", geom = "bar", aes(fill = after_stat(y)), show.legend = TRUE) + 
  # geom_bar(stat = "identity") + 
  labs(x = "", y = "Kilograms of Chemical Applied", fill = "") +
  scale_x_discrete(breaks = c("1990", "1995", "2000", "2005", "2010", "2015", "2020")) +
  scale_y_continuous(labels = scales::comma,
                     expand = expansion(mult = c(0, 0.05))) +
  scale_fill_distiller(palette = "Oranges",
                       trans = "reverse",
                       labels = scales::comma) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title.y = element_text(size = 20, 
                                    margin = margin(t = 0, b = 0, l = 0, r = 10))) + 
  guides(fill = guide_colorbar(reverse = TRUE))


# Plot of KG_COPPER_APPLIED
rice_all %>%
  group_by(YEAR) %>%
  summarize(KG_COPPER_APPLIED) %>%
  ggplot(aes(x = factor(YEAR), y = KG_COPPER_APPLIED)) + 
  stat_summary(fun = "sum", geom = "bar", aes(fill = after_stat(y)), show.legend = TRUE) + 
  # geom_bar(stat = "identity") + 
  labs(x = "", y = "Kilograms of Copper Applied", fill = "") +
  scale_x_discrete(breaks = c("1990", "1995", "2000", "2005", "2010", "2015", "2020")) +
  scale_y_continuous(labels = scales::comma,
                     expand = expansion(mult = c(0, 0.05))) +
  scale_fill_distiller(palette = "Oranges",
                       trans = "reverse",
                       labels = scales::comma) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title.y = element_text(size = 20, 
                                    margin = margin(t = 0, b = 0, l = 0, r = 10))) + 
  guides(fill = guide_colorbar(reverse = TRUE))

rice_all %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(POUNDS_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = factor(YEAR), y = POUNDS_CHEMICAL_APPLIED)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~COUNTY_NAME) +
  theme_bw()

```


### Clean up column info
```{r Clean up column info}
# Change all to title case and assign as factors

# allCu
allCu$APPLICATION_MONTH <- factor(str_to_title(allCu$APPLICATION_MONTH),
                                  levels = c("January", "February", "March", "April", "May", "June", 
                                             "July", "August", "September", "October", "November", "December"))
allCu$COUNTY_NAME <- factor(str_to_title(allCu$COUNTY_NAME))
allCu$CHEMICAL_NAME <- factor(str_to_title(allCu$CHEMICAL_NAME))
allCu$SITE_NAME <- factor(str_to_title(allCu$SITE_NAME))
allCu$PRODUCT_NAME <- factor(str_to_title(allCu$PRODUCT_NAME))

# rice
rice$APPLICATION_MONTH <- factor(str_to_title(rice$APPLICATION_MONTH),
                                  levels = c("January", "February", "March", "April", "May", "June", 
                                             "July", "August", "September", "October", "November", "December"))
rice$COUNTY_NAME <- factor(str_to_title(rice$COUNTY_NAME))
rice$CHEMICAL_NAME <- factor(str_to_title(rice$CHEMICAL_NAME))
rice$SITE_NAME <- factor(str_to_title(rice$SITE_NAME))
rice$PRODUCT_NAME <- factor(str_to_title(rice$PRODUCT_NAME))

```

### Split COMTRS into matching columns in PLSS df
```{r Split COMTRS}

# COMTRS stands for: county/meridian/township/range/section
# Non-ag pesticide use reports do not have this because they are reported at county level only.

# Digits 1&2 are county, 3rd = meridian, 4-6 = Township (xxN, xxS), 7-9 = Range (xxE, xxW), 10-11 = Section
# To match PLSS data, start all townships with "T", all ranges with "R", and abbreviate meridians as "HM", "MDM", "SBM", where "HM" = Humboldt, "MDM" = Mount Diablo, and "SBM" = San Bernardino
# So convert from CDPR to PLSS as meridan of: "H" --> "HM", "M" --> "MDM", & "S" --> "SBM"


allCu <- allCu %>%
  mutate(County_Num = str_sub(COMTRS, start = 1, end = 2),
         Meridian = str_sub(COMTRS, start = 3, end = 3),
         Township = str_sub(COMTRS, start = 4, end = 6),
         Range = str_sub(COMTRS, start = 7, end = 9),
         Section = str_sub(COMTRS, start = 10, end = 11))

# Further conversion to match PLSS (separated from above for clarity)
# Create a "TownshipRa" column as well
allCu <- allCu %>%
  mutate(Meridian = case_when(Meridian == "H" ~ "HM",
                              Meridian == "M" ~ "MDM",
                              Meridian == "S" ~ "SBM"),
         # Township = str_c("T", Township),
         # Range = str_c("R", Range),
         TownshipRa = str_c(Township, Range, sep = " "))


# Repeat for rice
rice <- rice %>%
  mutate(County_Num = str_sub(COMTRS, start = 1, end = 2),
         Meridian = str_sub(COMTRS, start = 3, end = 3),
         Township = str_sub(COMTRS, start = 4, end = 6),
         Range = str_sub(COMTRS, start = 7, end = 9),
         Section = str_sub(COMTRS, start = 10, end = 11))

# Further conversion to match PLSS (separated from above for clarity)
rice <- rice %>%
  mutate(Meridian = case_when(Meridian == "H" ~ "HM",
                              Meridian == "M" ~ "MDM",
                              Meridian == "S" ~ "SBM"),
         # Township = str_c("T", Township),
         # Range = str_c("R", Range),
         TownshipRa = str_c(Township, Range, sep = " "))
```


### Summary Statistics: Rice 
```{r Summary Stats: Rice}

# Bar graph of summary pounds applied by county and year
rice %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(POUNDS_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = COUNTY_NAME, y = POUNDS_CHEMICAL_APPLIED)) + 
  geom_boxplot() +
  facet_wrap(~YEAR) + 
  theme_bw()

rice %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(POUNDS_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = factor(YEAR), y = POUNDS_CHEMICAL_APPLIED)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~COUNTY_NAME) +
  theme_bw()

yrly_app <- 
  rice %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(total = mean(sum(POUNDS_CHEMICAL_APPLIED)))

rice %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(sum = sum(POUNDS_CHEMICAL_APPLIED)) %>%
  group_by(COUNTY_NAME) %>%
  summarize(mean = mean(sum),
            sd = sd(sum))

```


```{r Read in Spatial Data: PLSS}

# This is not the best dataset
# plss <- st_read("./Data/Spatial/Public_Land_Survey_System/Public_Land_Survey_System_(PLSS)%3A_Sections.shp")

# This one is better, because it includes county names and numbers already
plss <- st_read("./Data/Spatial/Statewide_CA_PLSS_NAD83AlbersCA/Statewide_CA_PLSS_NAD83AlbersCA.shp")


# plss[1:10000,]
# plot(plss[,"TownshipRa"])


# check geometry type
# object type is MULTIPOLYGON
# The 18 levels are the possible object types that it could be
# st_geometry_type(plss)
# plss[1]


# check CRS of the file data
# See that it is in WGS84, Pseudo-mercator
# st_crs(plss)

# To get extent of the file
# gives furthest N, S, E, W edges of the data
# st_bbox(plss)

# View all metadata and attributes, print to screen
# plss
# Or the first row
# plss[1,9]

# To plot, need to use geom_sf and coord_sf
# Note, this is MUCH FASTER than plot(plss) or using ggplot without geom_sf & coord_sf
# ggplotly(
# ggplot() +
#   geom_sf(data = plss_co) +
#   theme_bw() +
#   coord_sf()
# )

# View contents of a specific column, here just unique values
# unique(plss$TownshipRa)


# Group geometries by county
plss_co <- plss %>%
  group_by(NAME) %>%
  summarize(geometry = st_union(geometry))

# Group geometries by TownshipRange
plss_tr <- plss %>%
  mutate(TownshipRa = str_c(TOWNSHIP, RANGE, sep = " ")) %>%
  group_by(NAME, TownshipRa) %>%
  summarize(geometry = st_union(geometry))
```


## Remove CDPR object to save memory
```{r Remove CDPR and PLSS}
rm(cdpr)

```


## Creating NA data for every township/range and County: not necessary
```{r}

# Will need to create NA data for every township/section to be able to map the data

# check all townships and ranges shown in PLSS, allCu, rice dfs
# plssTR <- plss %>% count(TownshipRa)    # 3549 rows
# allCuTR <- allCu %>% count(TownshipRa)  # 1156 rows
# riceTR <- rice %>% count(TownshipRa)    # 120 rows


```


## Merging Rice Data to PLSS
```{r Merging rice data to plss}

# First need to summarize POUNDS_CHEMICAL_APPLIED by year and Township
rice_sum_tr <- rice %>%
  drop_na(Meridian) %>%
  group_by(YEAR, COUNTY_NAME, TownshipRa) %>%
  summarise(sum_lbs_applied = sum(POUNDS_CHEMICAL_APPLIED))

# Add COMTRS column to rice_sum, DO I NEED TO DO THIS??
# rice_sum_t <- left_join(x = rice_sum_t, y = rice[, c("COMTRS", "COUNTY_NAME", "Township")], by = "Township")


# Joined datasets year by year
plss_rice_tr2008 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2008, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2008))

plss_rice_tr2009 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2009, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2009))

plss_rice_tr2010 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2010, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2010))

plss_rice_tr2011 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2011, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2011))

plss_rice_tr2012 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2012, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2012))

plss_rice_tr2013 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2013, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2013))

plss_rice_tr2014 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2014, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2014))

plss_rice_tr2015 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2015, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2015))

plss_rice_tr2016 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2016, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2016))

plss_rice_tr2017 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2017, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2017))

plss_rice_tr2018 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2018, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2018))

plss_rice_tr2019 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2019, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2019))

plss_rice_tr2020 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2020, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2020))

plss_rice_tr2021 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2021, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2021))



# This may not be necessary:

# plss_rice_tr2021 <- plss_rice_tr2021 %>%
#   mutate(sum_lbs_applied = replace_na(sum_lbs_applied, 0))


plss_rice_tr_all <- bind_rows(plss_rice_tr2008, plss_rice_tr2009, plss_rice_tr2010, plss_rice_tr2011, plss_rice_tr2012,
                              plss_rice_tr2013, plss_rice_tr2014, plss_rice_tr2015, plss_rice_tr2016, plss_rice_tr2017,
                              plss_rice_tr2018, plss_rice_tr2019, plss_rice_tr2020, plss_rice_tr2021)


# Test to print just one year of data
ggplot() +
  geom_sf(data = plss_rice_tr_all[plss_rice_tr_all$YEAR == 2021,], 
          aes(geometry = geometry, fill = sum_lbs_applied)) + 
  theme_bw() + 
  coord_sf() +
  # facet_wrap(~YEAR) +
  scale_fill_distiller(name = "Total Pounds",
                     labels = comma,
                     trans = "reverse",
                     palette = "Oranges")


```


## Merging allCu Data to PLSS
```{r Merging rice data to plss}

# First need to summarize POUNDS_CHEMICAL_APPLIED by year and Township
allCu_sum_tr <- allCu %>%
  drop_na(Meridian) %>%
  group_by(YEAR, COUNTY_NAME, TownshipRa) %>%
  summarise(sum_lbs_applied = sum(POUNDS_CHEMICAL_APPLIED))

# Add COMTRS column to rice_sum, DO I NEED TO DO THIS??
# rice_sum_t <- left_join(x = rice_sum_t, y = rice[, c("COMTRS", "COUNTY_NAME", "Township")], by = "Township")


# Joined datasets year by year
plss_allCu_tr2008 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2008, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2008))

plss_allCu_tr2009 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2009, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2009))

plss_allCu_tr2010 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2010, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2010))

plss_allCu_tr2011 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2011, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2011))

plss_allCu_tr2012 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2012, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2012))

plss_allCu_tr2013 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2013, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2013))

plss_allCu_tr2014 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2014, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2014))

plss_allCu_tr2015 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2015, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2015))

plss_allCu_tr2016 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2016, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2016))

plss_allCu_tr2017 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2017, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2017))

plss_allCu_tr2018 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2018, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2018))

plss_allCu_tr2019 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2019, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2019))

plss_allCu_tr2020 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2020, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2020))

plss_allCu_tr2021 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2021, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2021))



# This may not be necessary:

# plss_rice_tr2021 <- plss_rice_tr2021 %>%
#   mutate(sum_lbs_applied = replace_na(sum_lbs_applied, 0))


plss_allCu_tr_all <- bind_rows(plss_allCu_tr2008, plss_allCu_tr2009, plss_allCu_tr2010, plss_allCu_tr2011, plss_allCu_tr2012,
                               plss_allCu_tr2013, plss_allCu_tr2014, plss_allCu_tr2015, plss_allCu_tr2016, plss_allCu_tr2017,
                               plss_allCu_tr2018, plss_allCu_tr2019, plss_allCu_tr2020, plss_allCu_tr2021)


# Test to print just one year of data
ggplot() +
  geom_sf(data = plss_allCu_tr_all[plss_allCu_tr_all$YEAR == 2021,], 
          aes(geometry = geometry, fill = sum_lbs_applied)) + 
  theme_bw() + 
  coord_sf() +
  # facet_wrap(~YEAR) +
  scale_fill_distiller(name = "Total Pounds",
                     labels = comma,
                     trans = "reverse",
                     palette = "Oranges")
```


# Mapview Package
```{r}
# install.packages("mapview")
library(mapview)

# Create palette to use
pal <- brewer.pal(n = 9, "Oranges")

# Convert counties sf data from polygon to line
plss_co_lines <- st_cast(plss_co, to = "MULTILINESTRING")

allCu_map <- 
  mapview(plss_allCu_tr_all[plss_allCu_tr_all$YEAR == 2021,],
          zcol = "sum_lbs_applied",
          col.region = pal,
          layer.name = "Total Pounds Cu Applied in 2021",
          popup = popupTable(plss_allCu_tr_all[plss_allCu_tr_all$YEAR == 2021,],
                             zcol = c("NAME", "TownshipRa", "sum_lbs_applied"))) + 
  mapview(plss_co_lines,
          color = "black", lwd = 1.5, legend = FALSE)

mapshot(allCu_map, url = paste0(getwd(), "/allCu_map.html"))


```


# Mapview Package With PopupGraph
```{r}
# install.packages("mapview")
library(mapview)

# Create palette to use
# pal <- brewer.pal(n = 9, "Oranges")

# Convert counties sf data from polygon to line
# plss_co_lines <- st_cast(plss_co, to = "MULTILINESTRING")

# Create the popupGraphs
# This is draft code for a piechart
# ggplot(data = allCu[allCu$YEAR == 2021 & allCu$TownshipRa == "47N 05E",],
#        aes(x = "", y = POUNDS_CHEMICAL_APPLIED, fill = SITE_NAME)) + 
#   geom_bar(stat = "identity", width = 1) + 
#   coord_polar("y", start = 0) +
#   theme_void()

p <- ggplot(data = plss_allCu_tr_all,
            aes(x = YEAR, y = sum_lbs_applied)) + 
  geom_bar(stat = "identity") + 
  theme_bw()

p <- mget(rep("p", length(unique(plss_allCu_tr_all$TownshipRa))))


clr <- rep("grey", length(unique(plss_allCu_tr_all$TownshipRa)))
p <- lapply(1:length(p), function(i) {
  clr[i] <- "red"
  update(p[[i]], col = clr)
})




allCu_map <- 
  mapview(plss_allCu_tr_all[plss_allCu_tr_all$YEAR == 2021,],
          zcol = "sum_lbs_applied",
          col.region = pal,
          layer.name = "Total Pounds Cu Applied in 2021",
          popup = popupTable(plss_allCu_tr_all[plss_allCu_tr_all$YEAR == 2021,],
                             zcol = c("NAME", "TownshipRa", "sum_lbs_applied"))) + 
  mapview(plss_co_lines,
          color = "black", lwd = 1.5, legend = FALSE)

mapshot(allCu_map, url = paste0(getwd(), "/allCu_map.html"))


```


# Testing code from https://r-spatial.github.io/mapview/articles/mapview_04-popups.html#graph-popups
```{r}
library(lattice)
library(sp)

data(meuse)
coordinates(meuse) <- ~x+y
proj4string(meuse) <- CRS("+init=epsg:28992")
p <- xyplot(copper ~ cadmium, data = meuse@data, col = "grey", pch = 20, cex = 2)
p <- mget(rep("p", length(meuse)))

clr <- rep("grey", length(meuse))
p <- lapply(1:length(p), function(i) {
  clr[i] <- "red"
  update(p[[i]], col = clr)
})


mapview(meuse,
        zcol = "cadmium",
        popup = popupGraph(p))
```

## NOTES
* need to clean up dataset
  - Fresno Co, TR: 12S 31E is WRONG (probably a typo that should have been 12S 21E)