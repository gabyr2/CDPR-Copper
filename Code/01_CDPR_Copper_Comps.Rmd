---
title: CDPR-Copper for Comps
output:
  html_document:
    keep_md: true
---

## Setup
```{r Setup}

library(ggplot2)
library(plotly)
library(tidyverse)
library(scales) # for viz
library(RColorBrewer) # for viz

# For spatial work
library(sf)
library(mapview) # plotting
library(leafpop) # for customizing popups on maps
```

## Read in Data: CDPR
```{r Read in Data: CDPR}

# Cu for all crops for 1990-2006
cdpr1 <- read_csv("D:/LocalRepos/CDPR-Copper_ExternalData/CalPIP_Cu_1990-2006.csv")

# Cu for all crops for 2007
cdpr2 <- read_csv("D:/LocalRepos/CDPR-Copper_ExternalData/CalPIP_Cu_2007.csv")

# All crops for 2008-2021
cdpr3 <- read_csv("D:/LocalRepos/CDPR-Copper_ExternalData/CalPIP_Cu_2008-2021.csv")

# Bind them all together
cdpr <- bind_rows(cdpr1, cdpr2, cdpr3)
```

## CDPR Data Clean-up
### Clean up SITES and Columns
```{r CDPR: Keep Any Ag SITES and Keep ONLY rice SITES}

# Counts of site types
sites <- cdpr %>% count(SITE_NAME)

# create df with ag-related SITE only, including any outdoor-related plant production
allCu <- cdpr %>% 
  filter(SITE_NAME != "" & 
           SITE_NAME != "AIRPORTS AND LANDING FIELDS (RUNWAYS, ETC.)" & 
           SITE_NAME != "ANIMAL HUSBANDRY PREMISES" & 
           SITE_NAME != "ANTIFOULING TREATMENT SITES (ALL OR UNSPEC)" & 
           SITE_NAME != "AQUATIC AREAS, WATER AREAS (ALL OR UNSPEC)" & 
           SITE_NAME != "AQUATIC SITE - HUMAN/ANIMAL USE (COMBINED SITE)" &
           SITE_NAME != "AQUATIC SITE - INDUSTRIAL USE (COMBINED SITE)" & 
           SITE_NAME != "BUILDINGS AND STRUCTURES (NON-AG OUTDOOR)" & 
           SITE_NAME != "CANNABIS (ALL OR UNSPECIFIED)" &
           SITE_NAME != "COMMERCIAL, INSTITUTIONAL OR INDUSTRIAL AREAS" &
           SITE_NAME != "COMMODITY FUMIGATION" & 
           SITE_NAME != "COUNTY AG. COMM. SALES" & 
           SITE_NAME != "FUMIGATION, OTHER" & 
           SITE_NAME != "GREENHOUSES (EMPTY) (ENVIRONS, BENCHES, ETC.)" & 
           SITE_NAME != "HUMAN DRINKING WATER SYSTEMS (POTABLE)" & 
           SITE_NAME != "INDUSTRIAL PROCESSING WATER" & 
           SITE_NAME != "INDUSTRIAL WASTE DISPOSAL SYSTEMS, DISPOSAL WATER" & 
           SITE_NAME != "IRRIGATION SYSTEMS (DITCHES, CANAL BANKS, ETC.)" & 
           SITE_NAME != "LANDSCAPE MAINTENANCE" & 
           SITE_NAME != "N-GRNHS GRWN CUT FLWRS OR GREENS" & 
           SITE_NAME != "N-GRNHS GRWN PLANTS IN CONTAINERS" & 
           SITE_NAME != "N-GRNHS GRWN TRNSPLNT/PRPGTV MTRL" & 
           # SITE_NAME != "N-OUTDR CONTAINER/FLD GRWN PLANTS" & 
           # SITE_NAME != "N-OUTDR GRWN CUT FLWRS OR GREENS" & 
           # SITE_NAME != "N-OUTDR GRWN TRNSPLNT/PRPGTV MTRL " & 
           SITE_NAME != "ORNAMENTAL TURF (ALL OR UNSPEC)" & 
           SITE_NAME != "PUBLIC HEALTH PEST CONTROL" & 
           SITE_NAME != "RECREATIONAL AREAS, TENNIS COURTS, PARKS, ETC." & 
           SITE_NAME != "REGULATORY PEST CONTROL" & 
           SITE_NAME != "RESEARCH COMMODITY" & 
           SITE_NAME != "RIGHTS OF WAY" & 
           # SITE_NAME != "SOIL APPLICATION, PREPLANT-OUTDOOR (SEEDBEDS,ETC.)" & 
           SITE_NAME != "STRUCTURAL PEST CONTROL" & 
           SITE_NAME != "SWIMMING POOL WATER SYSTEMS (POOLS, SPAS, ETC.)" & 
           SITE_NAME != "TURF, GOLF COURSE (FAIRWAYS, GREENS, ROUGH)" & 
           # SITE_NAME != "UNCULTIVATED AGRICULTURAL AREAS (ALL OR UNSPEC)" & 
           SITE_NAME != "UNCULTIVATED NON-AG AREAS (ALL OR UNSPEC)" & 
           SITE_NAME != "URBAN AREAS (ALL OR UNSPEC) (RESIDENTIAL, ETC.)" & 
           SITE_NAME != "VERTEBRATE PEST CONTROL" & 
           SITE_NAME != "WOOD PROTECTION TREATMENTS (ALL OR UNSPECIFIED)")


# Create df with rice-related SITE values only (total 65157 rows).  NOT REQUIRED TO DO THIS YET.
# rice <- cdpr %>%
#   filter(SITE_NAME == "RICE (ALL OR UNSPEC)" | SITE_NAME == "RICE, WILD (GRAIN CROP)")


# Remove unnecessary columns
allCu <- allCu[,-c(1, 3)]
# rice <- rice[,-c(1, 3)]

# Remove NA, blank values.  NOT NEEDED FOR RICE ONLY DF
# sum(is.na(allCu$POUNDS_CHEMICAL_APPLIED))
# sum(is.na(allCu$APPLICATION_MONTH))
# sum(allCu$POUNDS_CHEMICAL_APPLIED == "")
# sum(allCu$APPLICATION_MONTH == "")
# 
# sum(is.na(rice$POUNDS_CHEMICAL_APPLIED))
# sum(is.na(rice$APPLICATION_MONTH))
# sum(rice$POUNDS_CHEMICAL_APPLIED == "")
# sum(rice$APPLICATION_MONTH == "")
# 
# allCu <- allCu %>%
#   filter(!is.na(POUNDS_CHEMICAL_APPLIED)) %>%
#   filter(!is.na(APPLICATION_MONTH))
# 
# rice <- rice %>%
#   filter(!is.na(POUNDS_CHEMICAL_APPLIED)) %>%
#   filter(!is.na(APPLICATION_MONTH))
```

### Read in 1990-2007 Data and bind to rice df.  No longer required, I added 1990-2021 data for all crops
```{r Read in 1990-2007 data and bind}

# earlyrice <- read_csv("D:/LocalRepos/CDPR-Copper_ExternalData/CalPIP_Cu_Rice_1990-2007.csv")
# 
# # For now, I'm just making this a separate df from the below stuff so that the mapping code doesn't get messed up.  Eventually need to incorporate all years into the mapping df though for rice.
# 
# names(rice)
# names(earlyrice)
# 
# earlyrice <- earlyrice[ , -c(1, 3)]
# 
# rice_all <- bind_rows(rice, earlyrice)
```

#### Clean up column info and plots
```{r Clean up, Convert to kg}

### For all crops df first:
# Quick column clean-up
allCu$APPLICATION_MONTH <- factor(str_to_title(allCu$APPLICATION_MONTH),
                                  levels = c("January", "February", "March", "April", "May", "June", 
                                             "July", "August", "September", "October", "November", "December"))
allCu$COUNTY_NAME <- factor(str_to_title(allCu$COUNTY_NAME))
allCu$CHEMICAL_NAME <- factor(str_to_title(allCu$CHEMICAL_NAME))
allCu$SITE_NAME <- factor(str_to_title(allCu$SITE_NAME))
allCu$PRODUCT_NAME <- factor(str_to_title(allCu$PRODUCT_NAME))

# Convert pounds to kilograms
allCu <- allCu %>%
  mutate(KG_CHEMICAL_APPLIED = POUNDS_CHEMICAL_APPLIED*0.4535924,
         .after = POUNDS_CHEMICAL_APPLIED)

# Convert pounds chemical to pounds copper
# Create table of all chemicals used, then found conversions online
# Decided not to do this, because there are too many chemicals that have 'fuzzy' names and I cannot trace all of them accurately.  So, I will just plot kg of chemical applied
chemicals <- allCu %>% count(CHEMICAL_NAME)

# allCu <- allCu %>%
#   mutate(Cu_Conversion = case_when(CHEMICAL_NAME == "Copper Sulfate (Pentahydrate)" ~ 0.2545,
#                                    CHEMICAL_NAME == "Copper" ~ 1,
#                                    CHEMICAL_NAME == "Copper Sulfate (Basic)" ~ 0.4929,
#                                    CHEMICAL_NAME == "Copper Hydroxide" ~ 0.6513,
#                                    CHEMICAL_NAME == "Copper Oxychloride" ~ 0.2975,
#                                    CHEMICAL_NAME == "Copper Sulfate (Anhydrous)" ~ 0.3981,
#                                    CHEMICAL_NAME == "Copper Diammonium Diacetate Complex" ~ 0.08),
#          .after = KG_CHEMICAL_APPLIED)

# Convert pounds copper applied to kilograms copper
# allCu <- allCu %>%
#   mutate(KG_COPPER_APPLIED = KG_CHEMICAL_APPLIED*Cu_Conversion,
#          .after = Cu_Conversion)
```

# Plots made with just rice_all df.  Don't need to run this.
```{r rice_all: Plots}
# Plotting for Comps Proposal

# Plot of KG_CHEMICAL_APPLIED
rice_all %>%
  group_by(YEAR) %>%
  summarize(KG_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = factor(YEAR), y = KG_CHEMICAL_APPLIED)) + 
  stat_summary(fun = "sum", geom = "bar", aes(fill = after_stat(y)), show.legend = TRUE) + 
  # geom_bar(stat = "identity") + 
  labs(x = "", y = "Kilograms of Chemical Applied", fill = "") +
  scale_x_discrete(breaks = c("1990", "1995", "2000", "2005", "2010", "2015", "2020")) +
  scale_y_continuous(labels = scales::comma,
                     expand = expansion(mult = c(0, 0.05))) +
  scale_fill_distiller(palette = "Oranges",
                       trans = "reverse",
                       labels = scales::comma) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title.y = element_text(size = 20, 
                                    margin = margin(t = 0, b = 0, l = 0, r = 10))) + 
  guides(fill = guide_colorbar(reverse = TRUE))


# Plot of KG_COPPER_APPLIED
rice_all %>%
  group_by(YEAR) %>%
  summarize(KG_COPPER_APPLIED) %>%
  ggplot(aes(x = factor(YEAR), y = KG_COPPER_APPLIED)) + 
  stat_summary(fun = "sum", geom = "bar", aes(fill = after_stat(y)), show.legend = TRUE) + 
  # geom_bar(stat = "identity") + 
  labs(x = "", y = "Kilograms of Copper Applied", fill = "") +
  scale_x_discrete(breaks = c("1990", "1995", "2000", "2005", "2010", "2015", "2020")) +
  scale_y_continuous(labels = scales::comma,
                     expand = expansion(mult = c(0, 0.05))) +
  scale_fill_distiller(palette = "Oranges",
                       trans = "reverse",
                       labels = scales::comma) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title.y = element_text(size = 20, 
                                    margin = margin(t = 0, b = 0, l = 0, r = 10))) + 
  guides(fill = guide_colorbar(reverse = TRUE))

rice_all %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(POUNDS_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = factor(YEAR), y = POUNDS_CHEMICAL_APPLIED)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~COUNTY_NAME) +
  theme_bw()

```


### Clean up column info
```{r Clean up column info}
# Change all to title case and assign as factors

# allCu
allCu$APPLICATION_MONTH <- factor(str_to_title(allCu$APPLICATION_MONTH),
                                  levels = c("January", "February", "March", "April", "May", "June", 
                                             "July", "August", "September", "October", "November", "December"))
allCu$COUNTY_NAME <- factor(str_to_title(allCu$COUNTY_NAME))
allCu$CHEMICAL_NAME <- factor(str_to_title(allCu$CHEMICAL_NAME))
allCu$SITE_NAME <- factor(str_to_title(allCu$SITE_NAME))
allCu$PRODUCT_NAME <- factor(str_to_title(allCu$PRODUCT_NAME))

# rice
# rice$APPLICATION_MONTH <- factor(str_to_title(rice$APPLICATION_MONTH),
#                                   levels = c("January", "February", "March", "April", "May", "June", 
#                                              "July", "August", "September", "October", "November", "December"))
# rice$COUNTY_NAME <- factor(str_to_title(rice$COUNTY_NAME))
# rice$CHEMICAL_NAME <- factor(str_to_title(rice$CHEMICAL_NAME))
# rice$SITE_NAME <- factor(str_to_title(rice$SITE_NAME))
# rice$PRODUCT_NAME <- factor(str_to_title(rice$PRODUCT_NAME))

```

# Plots made with allCu data.
```{r rice_all: Plots}
# Plotting for Comps Proposal

# First, need to make column to classify rice crops
# These are the possible SITE_NAME values:
unique(allCu$SITE_NAME[str_detect(allCu$SITE_NAME, "Rice")])

# Create classifying variable
allCu <- allCu %>%
  mutate(RICE = case_when(SITE_NAME == "Rice (All Or Unspec)" ~ "Rice",
                          SITE_NAME == "Rice, Wild (Grain Crop)" ~ "Rice",
                          TRUE ~ "Not Rice"),
         .after = SITE_NAME)

# Double-check for accuracy
unique(allCu$RICE)


# Plot of KG_CHEMICAL_APPLIED, not split by RICE
allCu %>%
  group_by(YEAR) %>%
  summarize(KG_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = factor(YEAR), y = KG_CHEMICAL_APPLIED)) + 
  stat_summary(fun = "sum", geom = "bar", aes(fill = after_stat(y)), show.legend = TRUE) + 
  # geom_bar(stat = "identity") + 
  labs(x = "", y = "Kilograms of Chemical Applied", fill = "") +
  scale_x_discrete(breaks = c("1990", "1995", "2000", "2005", "2010", "2015", "2020")) +
  scale_y_continuous(labels = scales::comma,
                     expand = expansion(mult = c(0, 0.05))) +
  scale_fill_distiller(palette = "Oranges",
                       trans = "reverse",
                       labels = scales::comma) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title.y = element_text(size = 20, 
                                    margin = margin(t = 0, b = 0, l = 0, r = 10))) + 
  guides(fill = guide_colorbar(reverse = TRUE))


# Plot of KG_CHEMICAL_APPLIED, IS split by RICE
allCu %>%
  group_by(YEAR) %>%
  summarize(KG_CHEMICAL_APPLIED, RICE) %>%
  ggplot(aes(x = factor(YEAR), y = KG_CHEMICAL_APPLIED, fill = factor(RICE))) + 
  # stat_summary(fun = "sum", geom = "bar", show.legend = TRUE) + 
  geom_bar(stat = "identity", position = "stack") +
  labs(x = "", y = "Kilograms of Chemical Applied", fill = "") +
  scale_x_discrete(breaks = c("1990", "1995", "2000", "2005", "2010", "2015", "2020")) +
  scale_y_continuous(labels = scales::comma,
                     expand = expansion(mult = c(0, 0.05))) +
  scale_fill_manual(values = c("#fdae6b", "#e6550d"),
                    labels = c("Other Crops", "Rice")) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title.y = element_text(size = 20, 
                                    margin = margin(t = 0, b = 0, l = 0, r = 10)),
        legend.text = element_text(size = 13),
        legend.position = c(0.9, 0.9))


# Plot of KG_CHEMICAL_APPLIED, split by all crops
allCu %>%
  group_by(YEAR) %>%
  summarize(KG_CHEMICAL_APPLIED, SITE_NAME) %>%
  ggplot(aes(x = factor(YEAR), y = KG_CHEMICAL_APPLIED, fill = SITE_NAME)) + 
  # stat_summary(fun = "sum", geom = "bar", show.legend = TRUE) + 
  geom_bar(stat = "identity", position = "stack", show.legend = FALSE) +
  labs(x = "", y = "Kilograms of Chemical Applied", fill = "Rice Crop?") +
  scale_x_discrete(breaks = c("1990", "1995", "2000", "2005", "2010", "2015", "2020")) +
  scale_y_continuous(labels = scales::comma,
                     expand = expansion(mult = c(0, 0.05))) +
  # scale_fill_distiller(palette = "Oranges",
  #                      trans = "reverse",
  #                      labels = scales::comma) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title.y = element_text(size = 20, 
                                    margin = margin(t = 0, b = 0, l = 0, r = 10)))

# allCu data, faceted by county
allCu %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(POUNDS_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = factor(YEAR), y = POUNDS_CHEMICAL_APPLIED)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~COUNTY_NAME) +
  theme_bw()

```

## Preparing for Mapping
### Split COMTRS into matching columns in PLSS df
```{r Split COMTRS}

# COMTRS stands for: county/meridian/township/range/section
# Non-ag pesticide use reports do not have this because they are reported at county level only.

# Digits 1&2 are county, 3rd = meridian, 4-6 = Township (xxN, xxS), 7-9 = Range (xxE, xxW), 10-11 = Section
# To match PLSS data, start all townships with "T", all ranges with "R", and abbreviate meridians as "HM", "MDM", "SBM", where "HM" = Humboldt, "MDM" = Mount Diablo, and "SBM" = San Bernardino
# So convert from CDPR to PLSS as meridan of: "H" --> "HM", "M" --> "MDM", & "S" --> "SBM"


allCu <- allCu %>%
  mutate(County_Num = str_sub(COMTRS, start = 1, end = 2),
         Meridian = str_sub(COMTRS, start = 3, end = 3),
         Township = str_sub(COMTRS, start = 4, end = 6),
         Range = str_sub(COMTRS, start = 7, end = 9),
         Section = str_sub(COMTRS, start = 10, end = 11))

# Further conversion to match PLSS (separated from above for clarity)
# Create a "TownshipRa" column as well
allCu <- allCu %>%
  mutate(Meridian = case_when(Meridian == "H" ~ "HM",
                              Meridian == "M" ~ "MDM",
                              Meridian == "S" ~ "SBM"),
         # Township = str_c("T", Township),
         # Range = str_c("R", Range),
         TownshipRa = str_c(Township, Range, sep = " "))


# Repeat for rice.  NOT NEEDED
# rice <- rice %>%
#   mutate(County_Num = str_sub(COMTRS, start = 1, end = 2),
#          Meridian = str_sub(COMTRS, start = 3, end = 3),
#          Township = str_sub(COMTRS, start = 4, end = 6),
#          Range = str_sub(COMTRS, start = 7, end = 9),
#          Section = str_sub(COMTRS, start = 10, end = 11))

# Further conversion to match PLSS (separated from above for clarity)
# rice <- rice %>%
#   mutate(Meridian = case_when(Meridian == "H" ~ "HM",
#                               Meridian == "M" ~ "MDM",
#                               Meridian == "S" ~ "SBM"),
#          # Township = str_c("T", Township),
#          # Range = str_c("R", Range),
#          TownshipRa = str_c(Township, Range, sep = " "))
```


### Summary Statistics
```{r Summary Stats}

# Bar graph of summary pounds applied by county and year, for all, and for rice only
allCu %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(POUNDS_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = COUNTY_NAME, y = POUNDS_CHEMICAL_APPLIED)) + 
  geom_boxplot() +
  facet_wrap(~YEAR) + 
  theme_bw()

# Rice only
allCu[allCu$] %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(POUNDS_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = COUNTY_NAME, y = POUNDS_CHEMICAL_APPLIED)) + 
  geom_boxplot() +
  facet_wrap(~YEAR) + 
  theme_bw()

rice %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(POUNDS_CHEMICAL_APPLIED) %>%
  ggplot(aes(x = factor(YEAR), y = POUNDS_CHEMICAL_APPLIED)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~COUNTY_NAME) +
  theme_bw()

yrly_app <- 
  rice %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(total = mean(sum(POUNDS_CHEMICAL_APPLIED)))

rice %>%
  group_by(YEAR, COUNTY_NAME) %>%
  summarize(sum = sum(POUNDS_CHEMICAL_APPLIED)) %>%
  group_by(COUNTY_NAME) %>%
  summarize(mean = mean(sum),
            sd = sd(sum))

```


```{r Read in Spatial Data: PLSS}

# This is not the best dataset
# plss <- st_read("./Data/Spatial/Public_Land_Survey_System/Public_Land_Survey_System_(PLSS)%3A_Sections.shp")

# This one is better, because it includes county names and numbers already
plss <- st_read("./Data/Spatial/Statewide_CA_PLSS_NAD83AlbersCA/Statewide_CA_PLSS_NAD83AlbersCA.shp")


# plss[1:10000,]
# plot(plss[,"TownshipRa"])


# check geometry type
# object type is MULTIPOLYGON
# The 18 levels are the possible object types that it could be
# st_geometry_type(plss)
# plss[1]


# check CRS of the file data
# See that it is in WGS84, Pseudo-mercator
# st_crs(plss)

# To get extent of the file
# gives furthest N, S, E, W edges of the data
# st_bbox(plss)

# View all metadata and attributes, print to screen
# plss
# Or the first row
# plss[1,9]

# To plot, need to use geom_sf and coord_sf
# Note, this is MUCH FASTER than plot(plss) or using ggplot without geom_sf & coord_sf
# ggplotly(
# ggplot() +
#   geom_sf(data = plss_co) +
#   theme_bw() +
#   coord_sf()
# )

# View contents of a specific column, here just unique values
# unique(plss$TownshipRa)


# Group geometries by county
plss_co <- plss %>%
  group_by(NAME) %>%
  summarize(geometry = st_union(geometry))

# Group geometries by TownshipRange
plss_tr <- plss %>%
  mutate(TownshipRa = str_c(TOWNSHIP, RANGE, sep = " ")) %>%
  group_by(NAME, TownshipRa) %>%
  summarize(geometry = st_union(geometry))
```


## Remove CDPR objects to save memory
```{r Remove CDPR objects}
rm(cdpr, cdpr1, cdpr2, cdpr3)

```


## Creating NA data for every township/range and County: not necessary
This is actually not necessary because by leaving these township-range values as "NA", they will be plotted as grey, rather than as a light orange as part of the palette because they would be seen as 0.  Visually, having the NA (i.e., 0) values as grey helps the township-ranges with actual values to stand out better.  
```{r}

# Will need to create NA data for every township/section to be able to map the data

# check all townships and ranges shown in PLSS, allCu, rice dfs
# plssTR <- plss %>% count(TownshipRa)    # 3549 rows
# allCuTR <- allCu %>% count(TownshipRa)  # 1156 rows
# riceTR <- rice %>% count(TownshipRa)    # 120 rows


```


## Merging Rice Data to PLSS: Skip, just need to do this for allCu below
```{r Merging rice data to plss}

# First need to summarize POUNDS_CHEMICAL_APPLIED by year and Township
rice_sum_tr <- rice %>%
  drop_na(Meridian) %>%
  group_by(YEAR, COUNTY_NAME, TownshipRa) %>%
  summarise(sum_lbs_applied = sum(POUNDS_CHEMICAL_APPLIED))

# Add COMTRS column to rice_sum, DO I NEED TO DO THIS??
# rice_sum_t <- left_join(x = rice_sum_t, y = rice[, c("COMTRS", "COUNTY_NAME", "Township")], by = "Township")


# Joined datasets year by year
plss_rice_tr2008 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2008, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2008))

plss_rice_tr2009 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2009, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2009))

plss_rice_tr2010 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2010, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2010))

plss_rice_tr2011 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2011, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2011))

plss_rice_tr2012 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2012, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2012))

plss_rice_tr2013 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2013, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2013))

plss_rice_tr2014 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2014, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2014))

plss_rice_tr2015 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2015, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2015))

plss_rice_tr2016 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2016, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2016))

plss_rice_tr2017 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2017, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2017))

plss_rice_tr2018 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2018, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2018))

plss_rice_tr2019 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2019, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2019))

plss_rice_tr2020 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2020, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2020))

plss_rice_tr2021 <- left_join(x = plss_tr, 
                              y = rice_sum_tr[rice_sum_tr$YEAR == 2021, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2021))



# This may not be necessary:

# plss_rice_tr2021 <- plss_rice_tr2021 %>%
#   mutate(sum_lbs_applied = replace_na(sum_lbs_applied, 0))


plss_rice_tr_all <- bind_rows(plss_rice_tr2008, plss_rice_tr2009, plss_rice_tr2010, plss_rice_tr2011, plss_rice_tr2012,
                              plss_rice_tr2013, plss_rice_tr2014, plss_rice_tr2015, plss_rice_tr2016, plss_rice_tr2017,
                              plss_rice_tr2018, plss_rice_tr2019, plss_rice_tr2020, plss_rice_tr2021)


# Test to print just one year of data
ggplot() +
  geom_sf(data = plss_rice_tr_all[plss_rice_tr_all$YEAR == 2021,], 
          aes(geometry = geometry, fill = sum_lbs_applied)) + 
  theme_bw() + 
  coord_sf() +
  # facet_wrap(~YEAR) +
  scale_fill_distiller(name = "Total Pounds",
                     labels = comma,
                     trans = "reverse",
                     palette = "Oranges")


```


## Merging allCu Data to PLSS
```{r Merging rice data to plss}

# First need to summarize POUNDS_CHEMICAL_APPLIED by year and Township
allCu_sum_tr <- allCu %>%
  drop_na(Meridian) %>%
  group_by(YEAR, COUNTY_NAME, TownshipRa) %>%
  summarise(sum_kg_applied = sum(KG_CHEMICAL_APPLIED))

# Change TownshipRa 12S 31E to 12S 21E.  This was likely a typo, because it says that there was 1 application on peaches, but it is clear from the map that this is very mountainous terrain and is actually part of Kings Canyon NP.  I'm assuming that this was a typo, and instead of 31E it should be 21E, where there actually is farmland.
allCu_sum_tr$TownshipRa[allCu_sum_tr$TownshipRa == "12S 31E"] <- "12S 21E"

# Add COMTRS column to rice_sum, DO I NEED TO DO THIS??
# rice_sum_t <- left_join(x = rice_sum_t, y = rice[, c("COMTRS", "COUNTY_NAME", "Township")], by = "Township")


# Joined datasets year by year
plss_allCu_tr1990 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 1990, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 1990))

plss_allCu_tr1991 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 1991, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 1991))

plss_allCu_tr1992 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 1992, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 1992))

plss_allCu_tr1993 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 1993, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 1993))

plss_allCu_tr1994 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 1994, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 1994))

plss_allCu_tr1995 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 1995, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 1995))

plss_allCu_tr1996 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 1996, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 1996))

plss_allCu_tr1997 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 1997, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 1997))

plss_allCu_tr1998 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 1998, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 1998))

plss_allCu_tr1999 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 1999, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 1999))

plss_allCu_tr2000 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2000, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2000))

plss_allCu_tr2001 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2001, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2001))

plss_allCu_tr2002 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2002, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2002))

plss_allCu_tr2003 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2003, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2003))

plss_allCu_tr2004 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2004, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2004))

plss_allCu_tr2005 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2005, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2005))

plss_allCu_tr2006 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2006, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2006))

plss_allCu_tr2007 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2007, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2007))

plss_allCu_tr2008 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2008, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2008))

plss_allCu_tr2009 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2009, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2009))

plss_allCu_tr2010 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2010, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2010))

plss_allCu_tr2011 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2011, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2011))

plss_allCu_tr2012 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2012, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2012))

plss_allCu_tr2013 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2013, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2013))

plss_allCu_tr2014 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2014, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2014))

plss_allCu_tr2015 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2015, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2015))

plss_allCu_tr2016 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2016, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2016))

plss_allCu_tr2017 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2017, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2017))

plss_allCu_tr2018 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2018, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2018))

plss_allCu_tr2019 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2019, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2019))

plss_allCu_tr2020 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2020, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2020))

plss_allCu_tr2021 <- left_join(x = plss_tr, 
                              y = allCu_sum_tr[allCu_sum_tr$YEAR == 2021, ], 
                              by = c("TownshipRa" = "TownshipRa", "NAME" = "COUNTY_NAME")) %>%
  replace_na(list(YEAR = 2021))



# This may not be necessary:

# plss_rice_tr2021 <- plss_rice_tr2021 %>%
#   mutate(sum_lbs_applied = replace_na(sum_lbs_applied, 0))


plss_allCu_tr_all <- bind_rows(plss_allCu_tr1990, plss_allCu_tr1991, plss_allCu_tr1992, plss_allCu_tr1993, plss_allCu_tr1994,
                               plss_allCu_tr1995, plss_allCu_tr1996, plss_allCu_tr1997, plss_allCu_tr1998, plss_allCu_tr1999,
                               plss_allCu_tr2000, plss_allCu_tr2001, plss_allCu_tr2002, plss_allCu_tr2003, plss_allCu_tr2004,
                               plss_allCu_tr2005, plss_allCu_tr2006, plss_allCu_tr2007, plss_allCu_tr2008, plss_allCu_tr2009,
                               plss_allCu_tr2010, plss_allCu_tr2011, plss_allCu_tr2012, plss_allCu_tr2013, plss_allCu_tr2014,
                               plss_allCu_tr2015, plss_allCu_tr2016, plss_allCu_tr2017, plss_allCu_tr2018, plss_allCu_tr2019,
                               plss_allCu_tr2020, plss_allCu_tr2021)


# Test to print just one year of data
ggplot() +
  geom_sf(data = plss_allCu_tr_all[plss_allCu_tr_all$YEAR == 2021,], 
          aes(geometry = geometry, fill = sum_lbs_applied)) + 
  theme_bw() + 
  coord_sf() +
  # facet_wrap(~YEAR) +
  scale_fill_distiller(name = "Total Pounds",
                     labels = comma,
                     trans = "reverse",
                     palette = "Oranges")

# Plot when using just 2021 dataframe
# library(extrafont)
# library(extrafontdb)
# font_import()   # Run once
# loadfonts(device = "win")

# To get the degree symbol to work: Tools -> Graphics -> Backend -> Cairo

ggplot() +
  geom_sf(data = plss_allCu_tr2021, 
          aes(geometry = geometry, fill = sum_kg_applied)) + 
  theme_bw() + 
  coord_sf() +
  scale_fill_distiller(name = "Total Kilograms",
                     labels = comma,
                     trans = "reverse",
                     palette = "Oranges",
                     na.value = "grey") +
  theme(text = element_text(family = "Lato"),
        legend.position = c(0.7, 0.75),
        axis.text = element_text(size = 15),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))
```


# Statistics for Township 19N 02E.  
This code cell pulls just the data for township 19N 02E.  This township had the most copper-based chemical applications in 2021, based on viewing the map.  So, I wanted to look at the history of copper-based chemical applications at this township alone to describe the legacy of copper applications to this single 36 mi^2 square (23,040 ac = 9324 ha)
```{r}

riceT <- plss_allCu_tr_all[plss_allCu_tr_all$TownshipRa == "19N 02E" & plss_allCu_tr_all$NAME == "Butte", ]

# Using these statistics
# mean annual rate: 53,252 kg copper-based chemical per year
# since 1990, 1,704,053 kg of copper-based chemical applied in total.
summary(riceT)
sum(riceT$sum_kg_applied)


ggplot(data = riceT, aes(x = factor(YEAR), y = sum_kg_applied)) + 
  # stat_summary(fun = "sum", geom = "bar", aes(fill = after_stat(y)), show.legend = TRUE) + 
  geom_bar(stat = "identity") +
  labs(x = "", y = "Kilograms of Chemical Applied", fill = "") +
  scale_x_discrete(breaks = c("1990", "1995", "2000", "2005", "2010", "2015", "2020")) +
  scale_y_continuous(labels = scales::comma,
                     expand = expansion(mult = c(0, 0.05))) +
  scale_fill_distiller(palette = "Oranges",
                       trans = "reverse",
                       labels = scales::comma) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title.y = element_text(size = 20, 
                                    margin = margin(t = 0, b = 0, l = 0, r = 10))) + 
  guides(fill = guide_colorbar(reverse = TRUE))
```


# Mapview Package
```{r}
# install.packages("mapview")
library(mapview)

# Create palette to use
pal <- brewer.pal(n = 9, "Oranges")

# Convert counties sf data from polygon to line
plss_co_lines <- st_cast(plss_co, to = "MULTILINESTRING")

allCu_map <- 
  mapview(plss_allCu_tr_all[plss_allCu_tr_all$YEAR == 2021,],
          zcol = "sum_lbs_applied",
          col.region = pal,
          layer.name = "Total Pounds Cu Applied in 2021",
          popup = popupTable(plss_allCu_tr_all[plss_allCu_tr_all$YEAR == 2021,],
                             zcol = c("NAME", "TownshipRa", "sum_lbs_applied"))) + 
  mapview(plss_co_lines,
          color = "black", lwd = 1.5, legend = FALSE)

mapshot(allCu_map, url = paste0(getwd(), "/allCu_map.html"))


```


# Mapview Package With PopupGraph
```{r}
# install.packages("mapview")
library(mapview)

# Create palette to use
# pal <- brewer.pal(n = 9, "Oranges")

# Convert counties sf data from polygon to line
# plss_co_lines <- st_cast(plss_co, to = "MULTILINESTRING")

# Create the popupGraphs
# This is draft code for a piechart
# ggplot(data = allCu[allCu$YEAR == 2021 & allCu$TownshipRa == "47N 05E",],
#        aes(x = "", y = POUNDS_CHEMICAL_APPLIED, fill = SITE_NAME)) + 
#   geom_bar(stat = "identity", width = 1) + 
#   coord_polar("y", start = 0) +
#   theme_void()

p <- ggplot(data = plss_allCu_tr_all,
            aes(x = YEAR, y = sum_lbs_applied)) + 
  geom_bar(stat = "identity") + 
  theme_bw()

p <- mget(rep("p", length(unique(plss_allCu_tr_all$TownshipRa))))


clr <- rep("grey", length(unique(plss_allCu_tr_all$TownshipRa)))
p <- lapply(1:length(p), function(i) {
  clr[i] <- "red"
  update(p[[i]], col = clr)
})




allCu_map <- 
  mapview(plss_allCu_tr_all[plss_allCu_tr_all$YEAR == 2021,],
          zcol = "sum_lbs_applied",
          col.region = pal,
          layer.name = "Total Pounds Cu Applied in 2021",
          popup = popupTable(plss_allCu_tr_all[plss_allCu_tr_all$YEAR == 2021,],
                             zcol = c("NAME", "TownshipRa", "sum_lbs_applied"))) + 
  mapview(plss_co_lines,
          color = "black", lwd = 1.5, legend = FALSE)

mapshot(allCu_map, url = paste0(getwd(), "/allCu_map.html"))


```


# Testing code from https://r-spatial.github.io/mapview/articles/mapview_04-popups.html#graph-popups
```{r}
library(lattice)
library(sp)

data(meuse)
coordinates(meuse) <- ~x+y
proj4string(meuse) <- CRS("+init=epsg:28992")
p <- xyplot(copper ~ cadmium, data = meuse@data, col = "grey", pch = 20, cex = 2)
p <- mget(rep("p", length(meuse)))

clr <- rep("grey", length(meuse))
p <- lapply(1:length(p), function(i) {
  clr[i] <- "red"
  update(p[[i]], col = clr)
})


mapview(meuse,
        zcol = "cadmium",
        popup = popupGraph(p))
```

## NOTES
* need to clean up dataset
  - Fresno Co, TR: 12S 31E is WRONG (probably a typo that should have been 12S 21E)